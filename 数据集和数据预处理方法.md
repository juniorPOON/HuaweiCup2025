# 数据预处理方法

## 1. 文件读取与元数据解析

**目标**：在不打开全部原始波形的前提下，自动、稳定地获取每个样本的关键元信息，为后续切片、特征计算与分层抽样提供统一索引。

**实现要点**

1. **`.mat` 读取**：采用 `scipy.io.loadmat` 访问 MATLAB 数据文件中的变量；常见时域变量命名为 `X###_DE_time`、`X###_FE_time`、`X###_BA_time`，转速变量命名包含 `RPM`。
2. **正则解析**：利用正则表达式从**路径与文件名**中抽取元数据：
   - 采样率 `fs`：由目录名匹配 `(\d+)\s*kHz`，统一映射为 12000/32000/48000 Hz。
   - 通道 `channel`：优先从路径层名严格匹配 `*_DE_data`、`*_FE_data`（避免与“Centered”等词混淆）；若为 `Normal_data`，则回退扫描 `.mat` 键名是否含 `_DE_time/_FE_time` 以列举可用通道。
   - 标签 `label_str` 与二分类 `label_bin`：按文件名前缀匹配 `^(B|IR|OR|N)`；故障类记为 1，正常类记为 0。
   - 缺陷尺寸 `fault_size`：匹配文件名中的三/四位数字（如 `0007→7`），正常样本记 0。
   - 转速 `rpm`：优先从 `.mat` 的 `*RPM` 变量读取；若缺失，则从文件名中匹配 `\((\d+)rpm\)` 兜底。
   - 外圈空间位置（若适用）：解析 `@3/@6/@12` 或目录映射 `Orthogonal/Centered/Opposite`。
3. **文件级索引表**：将上述结果写入 `file_index.csv`；并在此基础上生成**文件级划分清单** `split_manifest.csv`，记录 `file_name, abs_path, fs, rpm, channel, label_str, label_bin, fault_size, split(train/val/test)` 等字段。

**意义**

- `fs` 决定频域分辨率、带通/抗混叠滤波与 STFT/Mel 参数；
- `channel` 约束信号键名选择，避免读错通道；
- `rpm` 用于计算机理频率（BPFO/BPFI/BSF/FTF），支撑可解释性与迁移对齐；
- `label_*`、`fault_size` 供任务一统计分析与任务二监督训练；
- 路径级与文件级正则解析形成“双保险”，增强跨目录结构的鲁棒性。

------

## 2. 数据集划分（先分文件，后切片）

**原则**：为避免“切片泄漏”（同一原始文件的重叠窗分别落入训练与测试），先**按文件**完成 6:2:2（train/val/test）分割，并对 `label_str` 做分层，保证各类在训练与测试均有覆盖。
 **产物**：`split_manifest.csv` 为后续切片与特征计算的唯一“事实来源”，两条路线（方法 A / Baseline）**共用**该清单，确保公平对比与可复现。

**意义**

- 从源头避免信息泄漏，保证任务二评估可信；
- 为任务三迁移提供干净的源域训练/验证集。

------

## 3. 时间切片（物理尺度对齐）

**策略**：采用固定时间窗切片以对齐物理过程，而非对齐采样点数。

- **窗长** 40 ms、**步长** 10 ms（75% 重叠）；
- 对应点数：12 kHz→480 点，32 kHz→1280 点，48 kHz→1920 点；
- 输出切片索引 `task1_slices_index.csv`：仅记录 `{file_name, abs_path, slice_start, slice_end, fs, rpm, channel, split, label_*}`。

**意义**

- **跨采样率友好**：相同“毫秒”窗保证物理时长一致，便于方法 A 的频域统一与 Baseline 的重采样对齐；
- **统计稳定**：40/10 ms 兼顾脉冲捕获与估计方差，利于时域统计与包络特征稳定计算；
- **任务三对齐**：目标域（32 kHz，约 600 rpm）切片策略与源域一致，减少域间偏移。

------

## 4. 双路线预处理（方法 A / Baseline）

### 方法 A（主线，不下采样，特征在 Hz 轴统一）

- **读取**：按切片索引载入指定通道。

- **频域对齐**：在各自 `fs` 下计算 STFT/Mel、包络谱，再将频轴**插值**到统一尺寸（如 128×128 的 Mel 图、2048-bin 包络谱向量）。

- **时域与包络能量**：计算均值、标准差、RMS、偏度、峭度、峰-峰值、波峰因子及包络谱能量积分。

- **机理峰值**：依据 `rpm` 与几何参数（SKF6205：滚动体数 n=9、滚动体直径 d=0.3126 in、节径 D=1.537 in、接触角 cosθ≈1）计算：

  fr=rpm60,BPFO=n2fr(1−dDcos⁡θ),  BPFI=n2fr(1+dDcos⁡θ),BSF=D2dfr(1−(dDcos⁡θ)2),  FTF=12fr(1−dDcos⁡θ).f_r=\frac{\mathrm{rpm}}{60},\quad \mathrm{BPFO}=\tfrac{n}{2}f_r(1-\tfrac{d}{D}\cos\theta),\; \mathrm{BPFI}=\tfrac{n}{2}f_r(1+\tfrac{d}{D}\cos\theta),\\ \mathrm{BSF}=\tfrac{D}{2d}f_r\left(1-(\tfrac{d}{D}\cos\theta)^2\right),\; \mathrm{FTF}=\tfrac{1}{2}f_r(1-\tfrac{d}{D}\cos\theta).

  在各理论频率±ΔHz 窗内提取峰值频率、峰幅与局部 SNR。

- **产物**：`task1_features_A.csv`（统计/能量）与 `task1_features_A_with_peaks.csv`（追加 BPFO/BPFI/BSF/FTF 峰值与 SNR）；频谱资产 `artifacts/A/...` 与索引 `task1_specs_A.csv`。

### Baseline（副线，统一重采样到 12 kHz）

- **抗混叠低通**：截止 ≤6 kHz；
- **重采样**：用 `resample_poly` 将 32/48 kHz 统一至 12 kHz；
- **后续流程**：与方法 A 相同（STFT/Mel、包络谱、统计特征与机理峰值提取）；
- **产物**：`task1_features_B.csv`、`task1_features_B_with_peaks.csv`、`artifacts/B/...`、`task1_specs_B.csv`。

**意义**

- 方法 A 保留高频信息并通过频轴插值实现“特征统一”，有利于后续迁移；
- Baseline 消除采样率“指纹”，提供严谨可比的对照；
- 两路线共用同一切片与数据划分，保证实验公平。

------

## 5. 频谱资产与质检

- **频谱资产**：导出 Log-Mel 频谱（`.npy` 训练版、可选 `.png` 展示版）与 2048-bin 包络谱向量（`.npy`），并以 `task1_specs_A/B.csv` 记录路径与元数据，供后续模型直接加载。
- **人类可读可视化**：分层抽样绘制波形对比（正常 vs 故障）、包络谱叠加 BPFO/BPFI/BSF 理论竖线与实测峰值、峭度/能量分布图；用于报告与质检。
- **标准化与复现**：仅用训练集估计标准化参数并写入 `stats.json`；异常切片（NaN/RMS≈0/读取失败）记录至 `bad_slices.csv`；汇总表 `qc_summary.txt` 用于复现与审计。

------

## 6. 对任务一–四的支撑关系

- **任务一（特征分析与提取）**：
  - 依赖本节生成的**切片索引**与**双路线特征表**（统计/包络能量/机理峰）；
  - 频谱资产用于图像化展示与后续深度建模对接；
  - `rpm`、`fs`、`channel` 等元数据用于频段选取、谱轴插值与机理频率计算。
- **任务二（源域故障诊断）**：
  - 直接读取 `task1_features_A/B*_with_peaks.csv` 进行传统学习（SVM/LightGBM/RF 等）；
  - 也可读取 `task1_specs_A/B.csv` 加载 Mel/包络谱 `.npy` 进行 CNN 训练；
  - `split=train/val/test` 保证评估规范性。
- **任务三（迁移诊断）**：
  - 方法 A 的**频域统一**（插值对齐）与 `rpm` 驱动的机理频率特征有助于降低域间偏移；
  - 可在对齐层引入 MMD/CORAL/DANN 等正则；
  - 目标域采用同样切片与频谱流程，保证输入分布形态一致。
- **任务四（可解释性）**：
  - BPFO/BPFI/BSF/FTF 的**理论–实测峰值/SNR**为“机理对齐”的定量锚点；
  - CNN 的 Grad-CAM 可与理论竖线重合度进行对照，验证模型关注的频带是否与故障机理一致；
  - 传统模型可用 SHAP/特征重要性与机理峰值特征联动解释。

------

**小结**：上述预处理流程以“路径/文件名正则 + `.mat` 键名读取”的双通道解析保障元数据准确，以“先文件划分后切片”的策略杜绝泄漏，以“时间窗切片 + 频轴统一/重采样”的双路线设计兼容不同采样率场景，并通过机理频率峰值度量将信号处理与物理机理闭环，面向任务一–四提供可复现、可解释、可迁移的特征基础。