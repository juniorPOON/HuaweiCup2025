# 🎯 任务一：最佳处理流程设计（方法 A + baseline）

> baseline 用来衬托方法 A 的合理性，体现我们**严谨 + 思路发散**；baseline 也是**保底**。

# ✅ 训练/验证/测试划分——正确时机与顺序

**总原则：先分文件，再切片。**（不然就会切片泄漏）

## A. 划分时机（放在最前面）

1. **收集文件清单**：每个 `.mat` = 一条记录（含 `file_name, label_str, label_bin, fs, rpm_mean, channel, fault_size`）。
2. **按文件做 6:2:2 分割**（train/val/test）：
   - **分割对象**：文件，不是切片。
   - **分层依据**：`label_str`（N/OR/IR/B）优先；如果类极不平衡，尽量保证每类在 train/test 都有。
   - **输出**：`split_manifest.csv`，字段：
      `file_name, split`（train/val/test/），`fold_id`（如用K折），其余元数据照抄。
3. **Route A & Baseline 共用这同一份 manifest**。
4. **之后才进行切片、特征提取、标准化等**（严格按 manifest 决定该文件的切片属于 train 还是 test）。

------

## 1. 数据选择与管理

- **传感器位置**
  - 主通道：**DE（驱动端）** ✅ —— 离轴承最近，信号最清晰（题目给了 SKF6205 参数）。
  - FE 可选；数据集没有 BA 就不强求。脚本预留入口即可。
- **标签生成（写入 CSV）**
  - 从文件名解析：N / OR / IR / B + 缺陷尺寸 + 载荷。
  - 两个标签字段：
    - `label_bin`：0=正常，1=故障（给 baseline 二分类/快速对比）。
    - `label_str`：N / OR / IR / B（给多分类 & 可解释性）。
- **（推荐）固定分割与路线标记**
  - `fold_id`：固定交叉验证/训练-验证-测试分割，A/B 两条路线共用，保证公平。
  - `route`：A 或 B（仅在特征 CSV 里标注来源，便于合并分析）。

------

## 2. 两种方案并行
- **切片方式（对于方法A和baseline同时按时间切片）**
  - 窗长 **40 ms**，步长 **10 ms**（按“毫秒”，不是“点数”）。
## 我们“凭什么”这样切？

用一句人话：**用时间尺度对齐物理世界**，别被不同采样率（12k/32k/48k）带偏。

- **物理对齐**：目标域 ~600 rpm ≈ 10 Hz（转一圈 ~100 ms）。故障调制频( BPFO/BPFI )通常是主轴频的多倍（几十 Hz）。
   → 40 ms 一窗能容纳 **1–3 个冲击/调制周期**，既看得到“节奏”，样本量也够多。
- **跨采样率友好**：40 ms 在 12k/32k/48k 分别是 480/1280/1920 点；**同样的物理时长**，后面再做频域统一就不慌。
- **统计稳定**：40/10 ms（75% overlap）让峭度、能量等统计量不至于“抖成筛子”。

> 备选：
>
> - 低转速/信噪比烂 → 可做个“**敏感性实验**”用 80 ms 再跑一遍，写进报告当鲁棒性说明。
> - 只想看高频瞬态 → 可试 20 ms（但别把主分析全换掉）。
### 方法 A（主线 ✅：**不下采样，特征在 Hz 轴统一**）
    - 12kHz → 480 点；32kHz → 1280 点；48kHz → 1920 点。
  - ✅ 这里“切片轴是时间”；**后续特征的横轴才是频率（Hz）**。
- **特征提取**
  1. **Mel / STFT 频谱图（喂 CNN）**
     - STFT：窗 40ms、hop 10ms，`n_fft` 取窗长最近的 2 的幂。
     - Mel：`n_mels=128`（或 256），`fmax=0.95×Nyquist`（随采样率变）。
     - **双线性插值到统一尺寸**（如 **128×128**），实现 Hz 轴对齐。
  2. **包络谱（物理先验）**
     - 带通 500–5500 Hz → Hilbert 包络 → FFT。
     - **频率轴插值**到 **2048 维**；同时提取 **BPFO/BPFI/BSF** 在 ±ΔHz 的峰值。
  3. **时域统计**
     - `mean, std, rms, skewness, kurtosis, peak2peak, crest_factor`
  4. **RPM**
     - 切片内取平均。
  5. **标准化**
     - 仅用训练集统计（mean/std），保存并用于 val/test。

> 公平性提示：**A 的特征 CSV 主表只存 ≤6 kHz 的 band energy**（与 baseline 可比）；如需利用 6–16/24 kHz 的高频，可另存 `hf_feature_path` 做消融/增强（不影响公平对比）。

------

### baseline（副线：**统一重采样到 12kHz**）衬托且保底

- **采样率统一**
  - 全部先**低通 ≤6 kHz**（抗混叠），再重采样到 **12 kHz**。
  - 12kHz 数据：本身已满足，不必滤波。
  - 32k/48k 数据：必须先低通，再用 `resample_poly`（32k→12k：3/8；48k→12k：1/4）。
- **切片方式**
  - 固定 **2048 点**窗、**1024 点**步（50% overlap ≈ **0.17 s**）。
- **特征提取**
  - 与方法 A **完全一致**（Mel/包络谱/统计/RPM/标准化一致）。

------

## 3. 可视化展示（让人类看懂）

- **波形切片**：正常 vs 故障（DE），直观看冲击感/不规则。
- **频谱/包络谱**：标出 **BPFO / BPFI / BSF** 理论竖线，看峰值是否对齐。
- **特征分布**：
  - 峭度箱线图（正常低、故障高）。
  - band energy 柱状图（各频段能量差异）。
- **A vs baseline**：各出一组图并排放，评委一眼懂。

------

## 4. 输出成果（双 CSV）

- `task1_slices_index.csv`（**公共索引**，不含模型特征）

  - `file_name, slice_start, slice_end, fs, rpm, label_bin, label_str, fold_id`

- `task1_features_A.csv`（方法 A 特征）

  - 上述统计/频域/包络谱 + `feature_path`（A 的图特征路径）+ `route='A'`
  - （可选）`hf_feature_path`：高频扩展特征路径（仅方法 A）

- `task1_features_B.csv`（baseline 特征）

  - 与 A 保持**同名同序**列 + `feature_path`（B 的图特征路径）+ `route='B'`

- `visualization/`：波形对比、包络谱、特征分布（A/B 各一套）

  # 📂 三份 CSV 的归属与作用

  ## 1）. `task1_slices_index.csv`（公共索引表）

  - **归属**：方法 A 和 baseline **共同使用**。
  - **内容**：
    - `file_name, slice_start, slice_end, fs, rpm, label_bin, label_str, fold_id`
  - **作用**：
    - 定义切片边界 + 标签。
    - 确保 **两条路线切片一致**（公平对比）。
    - `fold_id` 保证 A/B 的 train/val/test 分割完全一致。
  - **在任务里的位置**：
    - 数据清洗 & 统一管理。
    - 后续生成 `task1_features_A.csv` 和 `task1_features_B.csv` 都从它出发。

  ------

  ## 2）. `task1_features_A.csv`（方法 A 专属特征表，不下采样）

  - **归属**：方法 A（主线 ✅）。
  - **内容**：
    - 时域特征（mean, rms, kurtosis …）
    - 频域 band energy（0–6kHz 主表部分）
    - 包络谱特征（BPFO/BPFI/BSF）
    - `feature_path`：存放统一后的 Mel / 包络谱图（0–Nyquist 全频，插值到 128×128）。
    - **可选高频**：`hf_feature_path` → 存放 6–16/24 kHz 高频能量或 STFT 图。
    - 标签：`label_bin, label_str`
    - 路线标识：`route='A'`
  - **作用**：
    - 作为方法 A 的主要输入特征。
    - 主表和 baseline 可对比（≤6kHz），`hf_feature_path` 额外提供增强实验的高频信息。
  - **高频值怎么输入？**
    - 在生成特征时，除了 ≤6kHz 的 band energy，
       把高采样率数据的 **>6kHz 区间单独计算能量/频谱**，保存为 `.npy` 或 `.h5` 文件。
    - 在 CSV 里加一列：`hf_feature_path = features_A_hf/97_000.npy`。
    - 训练 baseline 时，忽略这个字段；
       训练方法 A 时，可以选择是否加载它，做「消融实验」。

  ------

  ## 3）. `task1_features_B.csv`（baseline 专属特征表，统一到12kHz）

  - **归属**：baseline（副线，用来衬托）。

  - **内容**：

    - 列名 & 顺序与 `task1_features_A.csv` 保持完全一致（方便比较）。
    - 没有 `hf_feature_path`（因为高频已经被带限掉了）。
    - `feature_path`：存放 baseline 生成的 Mel / 包络谱图（0–6kHz）。
    - 路线标识：`route='B'`

  - **作用**：

    - 给 baseline 模型用。

    - 作为对照基线，衬托方法 A 的价值。

      #  🚀csv表在任务里的用法

      - **任务1（数据预处理&可视化）**：
        - A vs B 对比图，用 `task1_features_A.csv` 和 `task1_features_B.csv`。
      - **任务2（建模）**：
        - baseline → 用 `task1_features_B.csv`。
        - 方法 A → 用 `task1_features_A.csv`（是否加载 `hf_feature_path` 决定实验配置）。
      - **任务3（迁移学习）**：
        - 依赖 `fs` + `rpm`（索引表里已有）。
      - **任务4（可解释性）**：
        - 包络谱特征（BPFO/BPFI/BSF）对齐 CNN 的 Grad-CAM。
        - 高频路径可用来展示：模型关注的频带是否在 >6kHz 区间。

------

## 🚀 承接到任务二/三/四

- **任务二**：
  - A：ResNet18（Mel）+ LightGBM（包络谱）。
  - B：RF/SVM/CNN。
  - **同一 `fold_id`**，对比 **Macro-F1（均值±std）** + 混淆矩阵。
- **任务三**：
  - A：天然跨采样率，配 **RPM** 做对齐；可加 **BN 重估 / MMD / DANN**。
  - B：作为简单迁移参照。
- **任务四**：
  - Grad-CAM 热区与 **BPFO/BPFI/BSF** 竖线重合度；
  - LightGBM 特征重要性 / SHAP 与包络谱峰值呼应。

------

## 📌 总结一句

- **主线（方法 A）**：保持原采样率，**按时间切片**，在 **Hz 轴统一特征**；信息最完整、迁移更稳。
- **对照（baseline）**：全部带限→**12 kHz**，其余流程一致；作为严谨的工程基线。
- **输出**：一份公共索引 + 两份特征 CSV + 成套可视化；公平可复现，答辩无死角。

------

